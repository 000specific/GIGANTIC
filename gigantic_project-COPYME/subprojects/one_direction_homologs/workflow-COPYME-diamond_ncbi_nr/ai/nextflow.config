// AI: Claude Code | Opus 4.6 | 2026 March 01 | Purpose: NextFlow configuration for DIAMOND NCBI nr pipeline
// Human: Eric Edsinger

// ============================================================================
// GIGANTIC One-Direction Homologs - NextFlow Configuration
// ============================================================================
//
// This file configures NextFlow execution settings.
// Users should NOT edit this file - edit diamond_ncbi_nr_config.yaml instead.
//
// ============================================================================


// ----------------------------------------------------------------------------
// Load user configuration from YAML
// ----------------------------------------------------------------------------
import org.yaml.snakeyaml.Yaml

def loadConfig() {
    def configFile = new File( "${projectDir}/../diamond_ncbi_nr_config.yaml" )
    if ( configFile.exists() ) {
        def yaml = new Yaml()
        return yaml.load( configFile.text )
    }
    return [:]
}

def userConfig = loadConfig()


// ----------------------------------------------------------------------------
// Pipeline parameters (from config YAML)
// ----------------------------------------------------------------------------
params {
    // Project settings
    project_name = userConfig?.project?.name ?: "my_project"

    // Input manifest
    proteome_manifest = "${projectDir}/../INPUT_user/proteome_manifest.tsv"

    // DIAMOND settings
    diamond_database = userConfig?.diamond?.database ?: "/path/to/nr.dmnd"
    evalue = userConfig?.diamond?.evalue ?: "1e-5"
    max_target_sequences = userConfig?.diamond?.max_target_sequences ?: 10
    num_parts = userConfig?.diamond?.num_parts ?: 40
    threads_per_job = userConfig?.diamond?.threads_per_job ?: 1

    // Output directory
    output_dir = "${projectDir}/../OUTPUT_pipeline"
}


// ----------------------------------------------------------------------------
// Executor settings
// ----------------------------------------------------------------------------
executor {
    // Default: local executor
    // Override for SLURM by setting NXF_EXECUTOR=slurm or using profiles below
    name = 'local'
    cpus = 4
    memory = '16 GB'
}


// ----------------------------------------------------------------------------
// Process defaults
// ----------------------------------------------------------------------------
process {
    // CRITICAL: Fail fast for research pipelines
    errorStrategy = 'terminate'
    maxErrors = 0    // Stop immediately on first failure
    maxRetries = 0   // No retries by default

    // Default resources (small tasks)
    cpus = 1
    memory = '4 GB'
    time = '1h'

    // Per-process resource overrides
    withName: 'diamond_search' {
        cpus = params.threads_per_job
        memory = '21 GB'
        time = '4d'
    }

    withName: 'split_proteomes' {
        memory = '8 GB'
        time = '2h'
    }

    withName: 'combine_results' {
        memory = '8 GB'
        time = '2h'
    }

    withName: 'identify_top_hits' {
        memory = '16 GB'
        time = '4h'
    }
}


// ----------------------------------------------------------------------------
// Profiles for different execution environments
// ----------------------------------------------------------------------------
profiles {
    // Local execution (default)
    standard {
        executor.name = 'local'
    }

    // SLURM cluster execution
    slurm {
        executor {
            name = 'slurm'
            queueSize = 3000
            submitRateLimit = '10 sec'
        }
        process {
            executor = 'slurm'
            queue = 'hpg-default'
            clusterOptions = '--account=moroz --qos=moroz-b'

            withName: 'diamond_search' {
                clusterOptions = '--account=moroz --qos=moroz-b'
            }
        }
    }
}


// ----------------------------------------------------------------------------
// Reporting
// ----------------------------------------------------------------------------
report {
    enabled = true
    file = "${params.output_dir}/pipeline_report.html"
    overwrite = true
}

timeline {
    enabled = true
    file = "${params.output_dir}/pipeline_timeline.html"
    overwrite = true
}
