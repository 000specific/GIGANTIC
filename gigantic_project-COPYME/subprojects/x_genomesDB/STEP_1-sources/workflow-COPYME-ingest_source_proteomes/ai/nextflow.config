/*
 * GIGANTIC Source Proteome Ingestion Pipeline - NextFlow Configuration
 * AI: Claude Code | Opus 4.5 | 2026 February 12
 * Human: Eric Edsinger
 *
 * NOTE: Users should edit ingest_sources_config.yaml, NOT this file.
 * This file reads from config.yaml and sets up NextFlow internals.
 *
 * Pattern: A (Sequential) - executor = 'local'
 * All processes run sequentially within a single job.
 */

// ============================================================================
// LOAD USER CONFIGURATION FROM YAML
// ============================================================================

import org.yaml.snakeyaml.Yaml

def loadConfig() {
    // Config file is in workflow root (parent of ai/ folder where this file lives)
    def configFile = new File("${projectDir}/../ingest_sources_config.yaml")
    if (configFile.exists()) {
        def yaml = new Yaml()
        return yaml.load(configFile.text)
    }
    return [:]
}

def userConfig = loadConfig()

// ============================================================================
// PARAMETERS (from ingest_sources_config.yaml)
// ============================================================================

params {
    // Project settings
    project_name = userConfig?.project?.name ?: "my_project"
    source_manifest = userConfig?.project?.source_manifest ?: "INPUT_user/source_manifest.tsv"

    // Output settings
    output_dir = userConfig?.output?.base_dir ?: "OUTPUT_pipeline"

    // Ingestion settings
    overwrite_existing = userConfig?.ingestion?.overwrite_existing ?: false
    missing_file_action = userConfig?.ingestion?.missing_file_action ?: "error"
}

// ============================================================================
// EXECUTOR - Pattern A (Sequential/Local)
// ============================================================================

executor {
    name = 'local'
    cpus = 1
    memory = '4 GB'
}

// ============================================================================
// PROCESS DEFAULTS
// ============================================================================

process {
    executor = 'local'

    // Error handling - fail fast for research pipelines
    errorStrategy = 'terminate'
    maxErrors = 0

    // Default resources (lightweight for this pipeline - just copying files)
    cpus = 1
    memory = '2 GB'
    time = '1h'
}

// ============================================================================
// MANIFEST
// ============================================================================

manifest {
    name = 'GIGANTIC-Ingest-Sources'
    author = 'Eric Edsinger (with Claude Code AI)'
    description = 'Ingest user-provided proteome files into GIGANTIC structure'
    version = '1.0.0'
    nextflowVersion = '>=21.04.0'
}

// ============================================================================
// REPORTS (optional - uncomment to enable)
// ============================================================================

// timeline {
//     enabled = true
//     file = "${params.output_dir}/nextflow_timeline.html"
// }
//
// report {
//     enabled = true
//     file = "${params.output_dir}/nextflow_report.html"
// }
