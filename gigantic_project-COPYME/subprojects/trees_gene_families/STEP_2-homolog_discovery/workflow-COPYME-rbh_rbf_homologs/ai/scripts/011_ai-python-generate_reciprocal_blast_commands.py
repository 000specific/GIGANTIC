#!/usr/bin/env python3
# GIGANTIC BLOCK 2 - Script 011: Generate Reciprocal BLAST Commands
# AI: Claude Code | Sonnet 4.5 | 2025 November 08 18:15 | Purpose: Generate reciprocal BLAST commands against RGS databases
# Human: Eric Edsinger

"""
Generate Reciprocal BLAST Commands

This script generates the command to perform reciprocal BLAST - searching blast gene
sequences (BGS, from forward BLAST against project databases) back against RGS genome databases.

This is the critical step in reciprocal best hit / reciprocal best family (RBH/RBF) analysis:
1. Forward BLAST: RGS → Project databases (scripts 002-004)
2. RGS genome BLAST: RGS → RGS genomes (scripts 005-006) 
3. **Reciprocal BLAST: BGS → RGS databases (this script)**
4. Extract CGS: Identify reciprocal best hits (script 013)

Workflow Context:
    Script 010 → makeblastdb → **Script 011** → Reciprocal BLAST → Script 012
    
Input Files:
    - output/4-output/4_ai-blastp-hit-regions.fasta - Candidate gene sequences (from script 004)
    - output/10-output/*-blastdb - BLAST databases (created by script 010)
    
Output Files:
    - 12-reciprocal-blast-commands.sh - Executable shell script for reciprocal BLAST

Usage:
    python3 011_ai-python-generate_reciprocal_blast_commands.py \\
        --query-fasta output/10-CGS-hitregions.aa \\
        --database-prefix output/8-rgs-with-genome-identifiers-blastdb \\
        --output-script 12-reciprocal-blast-commands.sh \\
        --output-report output/12-reciprocal-blast-report.txt \\
        --evalue 1e-3 \\
        --threads 30 \\
        --conda-env blast
"""

import argparse
import logging
import sys
from pathlib import Path
from datetime import datetime


def setup_logging() -> logging.Logger:
    """Configure logging with timestamps and levels."""
    logging.basicConfig(
        level=logging.INFO,
        format='%(asctime)s - %(levelname)s - %(message)s',
        datefmt='%Y-%m-%d %H:%M:%S'
    )
    return logging.getLogger( __name__ )


def generate_reciprocal_blast_command(
    query_fasta: Path,
    database_prefix: str,
    output_report: Path,
    evalue: float,
    threads: int,
    logger: logging.Logger
) -> str:
    """
    Generate reciprocal BLASTP command.
    
    Uses BLAST output format 6 (tab-separated) with standard fields:
        query_id, subject_id, percent_identity, alignment_length, mismatches,
        gap_opens, query_start, query_end, subject_start, subject_end, evalue, bit_score
    
    Args:
        query_fasta: Candidate gene sequences FASTA
        database_prefix: BLAST database name prefix
        output_report: Output BLAST report file
        evalue: E-value threshold
        threads: Number of CPU threads
        logger: Logger instance
        
    Returns:
        BLASTP command string
    """
    logger.info( "\nGenerating reciprocal BLASTP command..." )
    logger.info( f"  Query: {query_fasta}" )
    logger.info( f"  Database: {database_prefix}" )
    logger.info( f"  Output: {output_report}" )
    logger.info( f"  E-value: {evalue}" )
    logger.info( f"  Threads: {threads}" )
    
    # Build BLASTP command
    command = (
        f"blastp "
        f"-query {query_fasta} "
        f"-db {database_prefix} "
        f"-out {output_report} "
        f"-outfmt 6 "
        f"-evalue {evalue} "
        f"-num_threads {threads} "
        f"-max_target_seqs 1 "
        f"-max_hsps 1"
    )
    
    return command


def write_reciprocal_blast_script(
    output_script: Path,
    blast_command: str,
    conda_env: str,
    logger: logging.Logger
) -> None:
    """
    Write reciprocal BLAST command to executable shell script.
    
    Args:
        output_script: Output script file path
        blast_command: BLASTP command to execute
        conda_env: Conda environment name
        logger: Logger instance
    """
    logger.info( f"\nWriting reciprocal BLAST script: {output_script}" )
    
    with open( output_script, 'w' ) as output_file:
        # Write header
        output_file.write( "#!/bin/bash\n" )
        output_file.write( "# AI: Claude Code | Sonnet 4.5 | 2025 November 08 | Purpose: Execute reciprocal BLAST against RGS databases\n" )
        output_file.write( "# Human: Eric Edsinger\n" )
        output_file.write( "# Generated by: 011_ai-python-generate_reciprocal_blast_commands.py\n\n" )
        
        # Activate conda environment
        output_file.write( "# Activate BLAST conda environment\n" )
        output_file.write( "eval \"$(conda shell.bash hook)\"\n" )
        output_file.write( f"conda activate {conda_env}\n\n" )
        
        # Write BLAST command
        output_file.write( "# Execute reciprocal BLASTP\n" )
        output_file.write( "echo 'Starting reciprocal BLAST search...'\n" )
        output_file.write( f"{blast_command}\n\n" )
        
        # Check completion
        output_file.write( "if [ $? -eq 0 ]; then\n" )
        output_file.write( "    echo 'Reciprocal BLAST completed successfully'\n" )
        output_file.write( "else\n" )
        output_file.write( "    echo 'ERROR: Reciprocal BLAST failed'\n" )
        output_file.write( "    exit 1\n" )
        output_file.write( "fi\n" )
    
    # Make script executable
    output_script.chmod( 0o755 )
    
    logger.info( "Script written and made executable" )


def main():
    """Main execution function."""
    parser = argparse.ArgumentParser(
        description='Generate reciprocal BLAST commands against RGS databases'
    )
    
    parser.add_argument(
        '--query-fasta',
        type=str,
        required=True,
        help='Blast gene sequences (BGS) FASTA file (from script 004)'
    )
    
    parser.add_argument(
        '--database-prefix',
        type=str,
        required=True,
        help='BLAST database name prefix (output of makeblastdb)'
    )
    
    parser.add_argument(
        '--output-script',
        type=str,
        default='012_ai-bash-execute_reciprocal_blast.sh',
        help='Output BASH script for reciprocal BLAST execution (default: 012_ai-bash-execute_reciprocal_blast.sh)'
    )
    
    parser.add_argument(
        '--output-report',
        type=str,
        required=True,
        help='Output BLAST report file'
    )
    
    parser.add_argument(
        '--evalue',
        type=float,
        default=1e-3,
        help='E-value threshold (default: 1e-3)'
    )
    
    parser.add_argument(
        '--threads',
        type=int,
        default=30,
        help='Number of CPU threads (default: 30)'
    )
    
    parser.add_argument(
        '--conda-env',
        type=str,
        default='blast',
        help='Conda environment for BLAST (default: blast)'
    )
    
    arguments = parser.parse_args()
    logger = setup_logging()
    
    # Log script start
    logger.info( "=" * 80 )
    logger.info( "Generate Reciprocal BLAST Commands" )
    logger.info( "=" * 80 )
    logger.info( f"Script started at: {datetime.now().strftime( '%Y-%m-%d %H:%M:%S' )}" )
    
    # Convert paths
    query_fasta = Path( arguments.query_fasta )
    output_script_file = Path( arguments.output_script )
    output_report_file = Path( arguments.output_report )
    
    # Create script output directory
    script_output_dir = output_report_file.parent
    script_output_dir.mkdir( parents=True, exist_ok=True )
    
    # Validate query FASTA exists
    if not query_fasta.exists():
        logger.error( f"Query FASTA not found: {query_fasta}" )
        logger.error( "This file should be created by script 004" )
        sys.exit( 1 )
    
    # Generate BLAST command
    blast_command = generate_reciprocal_blast_command(
        query_fasta,
        arguments.database_prefix,
        output_report_file,
        arguments.evalue,
        arguments.threads,
        logger
    )
    
    # Write script
    write_reciprocal_blast_script(
        output_script_file,
        blast_command,
        arguments.conda_env,
        logger
    )
    
    # Summary
    logger.info( "\n" + "=" * 80 )
    logger.info( "SCRIPT COMPLETE" )
    logger.info( "=" * 80 )
    logger.info( f"Generated script: {output_script_file}" )
    logger.info( f"Output will be: {output_report_file}" )
    logger.info( f"\nTo execute: ./{output_script_file}" )
    logger.info( f"\nThis reciprocal BLAST will:" )
    logger.info( f"  1. Search candidate genes against RGS genome databases" )
    logger.info( f"  2. Identify reciprocal best hits" )
    logger.info( f"  3. Enable validation of forward BLAST results" )
    logger.info( f"\nScript completed at: {datetime.now().strftime( '%Y-%m-%d %H:%M:%S' )}" )


if __name__ == '__main__':
    main()

