/*
 * GIGANTIC trees_gene_families STEP_2 - NextFlow Configuration
 * AI: Claude Code | Opus 4.6 | 2026 February 27
 * Human: Eric Edsinger
 *
 * NOTE: Users should edit rbh_rbf_homologs_config.yaml, NOT this file.
 * This file reads from config.yaml and sets up NextFlow internals.
 */

// ============================================================================
// LOAD USER CONFIGURATION FROM YAML
// ============================================================================

import org.yaml.snakeyaml.Yaml

def loadConfig() {
    def configFile = new File("${projectDir}/../rbh_rbf_homologs_config.yaml")
    if (configFile.exists()) {
        def yaml = new Yaml()
        return yaml.load(configFile.text)
    }
    return [:]
}

def userConfig = loadConfig()

// ============================================================================
// PARAMETERS (from rbh_rbf_homologs_config.yaml)
// ============================================================================

params {
    // Gene family (single gene family per workflow copy)
    gene_family = userConfig?.gene_family?.name ?: null
    rgs_file = userConfig?.gene_family?.rgs_file ?: null

    // User input files
    species_keeper_list = userConfig?.inputs?.species_keeper_list ?: "INPUT_user/species_keeper_list.tsv"
    rgs_species_map = userConfig?.inputs?.rgs_species_map ?: "INPUT_user/rgs_species_map.tsv"

    // BLAST database paths (must be set by user in config)
    blast_databases_dir = userConfig?.inputs?.blast_databases_dir ?: null
    rgs_genomes_dir = userConfig?.inputs?.rgs_genomes_dir ?: null
    cgs_mapping_file = userConfig?.inputs?.cgs_mapping_file ?: null

    // Project settings
    project_database = userConfig?.project?.database ?: "species67_T1-species67"

    // BLAST parameters
    blast_evalue = userConfig?.blast?.evalue ?: "1e-3"
    blast_threads = userConfig?.blast?.threads ?: 50
    blast_conda_env = userConfig?.blast?.conda_env ?: "blast"

    // Output
    output_dir = userConfig?.output?.base_dir ?: "OUTPUT_pipeline"
}

// ============================================================================
// EXECUTOR - Local Execution
// ============================================================================

executor {
    name = 'local'
    cpus = 16
    memory = '64 GB'
}

// ============================================================================
// PROCESS DEFAULTS
// ============================================================================

process {
    executor = 'local'

    // Error handling - fail fast for research pipelines
    errorStrategy = 'terminate'
    maxErrors = 0

    // Default resources
    cpus = 4
    memory = '16 GB'
    time = '6h'

    // Label-specific resources
    withLabel: 'local' {
        cpus = 4
        memory = '16 GB'
        time = '2h'
    }

    withLabel: 'blast' {
        cpus = 16
        memory = '64 GB'
        time = '48h'
    }
}

// ============================================================================
// MANIFEST
// ============================================================================

manifest {
    name = 'GIGANTIC-trees_gene_families-STEP_2'
    author = 'Eric Edsinger (with Claude Code AI)'
    description = 'RBH/RBF homolog discovery via reciprocal BLAST'
    version = '1.0.0'
    nextflowVersion = '>=21.04.0'
}
