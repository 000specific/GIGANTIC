// AI: Claude Code | Opus 4.6 | 2026 February 27 | Purpose: NextFlow configuration for STEP_3 phylogenetic analysis
// Human: Eric Edsinger

// ============================================================================
// STEP_3 Phylogenetic Analysis - NextFlow Configuration
// ============================================================================

// Load user config from YAML
import org.yaml.snakeyaml.Yaml

def yaml = new Yaml()
def config_file = file( "${projectDir}/../phylogenetic_analysis_config.yaml" )
def user_config = config_file.exists() ? yaml.load( config_file.text ) : [:]

// Execution settings
process {
    executor = 'local'
    errorStrategy = 'terminate'
    maxRetries = 0
    maxErrors = 0

    // Default resources for local processes
    withLabel: 'local' {
        cpus = 4
        memory = '16 GB'
        time = '2h'
    }

    // MAFFT alignment (resource-intensive)
    withLabel: 'mafft' {
        cpus = user_config?.slurm?.mafft?.cpus ?: 50
        memory = user_config?.slurm?.mafft?.memory ?: '64 GB'
        time = user_config?.slurm?.mafft?.time ?: '48h'
    }

    // ClipKit trimming
    withLabel: 'clipkit' {
        cpus = 4
        memory = '16 GB'
        time = '4h'
    }

    // FastTree (relatively fast)
    withLabel: 'fasttree' {
        cpus = 4
        memory = '16 GB'
        time = '4h'
    }

    // IQ-TREE (very resource-intensive)
    withLabel: 'iqtree' {
        cpus = user_config?.slurm?.iqtree?.cpus ?: 50
        memory = user_config?.slurm?.iqtree?.memory ?: '64 GB'
        time = user_config?.slurm?.iqtree?.time ?: '100h'
    }

    // Visualization
    withLabel: 'visualization' {
        cpus = 4
        memory = '16 GB'
        time = '2h'
    }
}

// Reporting
timeline {
    enabled = true
    file = "${projectDir}/../${user_config?.output?.base_dir ?: 'OUTPUT_pipeline'}/phylogenetic_analysis_timeline.html"
    overwrite = true
}

report {
    enabled = true
    file = "${projectDir}/../${user_config?.output?.base_dir ?: 'OUTPUT_pipeline'}/phylogenetic_analysis_report.html"
    overwrite = true
}

trace {
    enabled = true
    file = "${projectDir}/../${user_config?.output?.base_dir ?: 'OUTPUT_pipeline'}/phylogenetic_analysis_trace.txt"
    overwrite = true
}

dag {
    enabled = true
    file = "${projectDir}/../${user_config?.output?.base_dir ?: 'OUTPUT_pipeline'}/phylogenetic_analysis_dag.svg"
    overwrite = true
}

// Manifest
manifest {
    name = 'GIGANTIC STEP_3 Phylogenetic Analysis'
    author = 'Eric Edsinger (with AI: Claude Code | Opus 4.6)'
    description = 'Phylogenetic analysis with configurable tree-building methods'
    mainScript = 'main.nf'
    version = '1.0.0'
    nextflowVersion = '>=21.04.0'
}
