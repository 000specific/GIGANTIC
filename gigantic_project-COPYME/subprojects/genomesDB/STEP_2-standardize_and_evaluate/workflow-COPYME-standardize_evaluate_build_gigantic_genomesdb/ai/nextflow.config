/*
 * GIGANTIC genomesDB STEP_2 - NextFlow Configuration
 * AI: Claude Code | Opus 4.6 | 2026 February 27
 * Human: Eric Edsinger
 *
 * NOTE: Users should edit standardize_evaluate_config.yaml, NOT this file.
 * This file reads from config.yaml and sets up NextFlow internals.
 */

// ============================================================================
// LOAD USER CONFIGURATION FROM YAML
// ============================================================================

import org.yaml.snakeyaml.Yaml

def loadConfig() {
    def configFile = new File("${projectDir}/../standardize_evaluate_config.yaml")
    if (configFile.exists()) {
        def yaml = new Yaml()
        return yaml.load(configFile.text)
    }
    return [:]
}

def userConfig = loadConfig()

// ============================================================================
// PARAMETERS (from standardize_evaluate_config.yaml)
// ============================================================================

params {
    // Input paths
    phylonames_mapping = userConfig?.inputs?.phylonames_mapping ?: "../../../phylonames/output_to_input/maps/species71_map-genus_species_X_phylonames.tsv"
    input_proteomes = userConfig?.inputs?.proteomes ?: "../../STEP_1-sources/output_to_input/T1_proteomes"
    input_genomes = userConfig?.inputs?.genomes ?: "../../STEP_1-sources/output_to_input/genomes"
    input_gene_annotations = userConfig?.inputs?.gene_annotations ?: "../../STEP_1-sources/output_to_input/gene_annotations"
    busco_lineages = userConfig?.inputs?.busco_lineages ?: "INPUT_user/busco_lineages.txt"

    // Output settings
    output_dir = userConfig?.output?.base_dir ?: "OUTPUT_pipeline"

    // BUSCO settings
    busco_parallel = userConfig?.busco?.parallel ?: 4
    busco_cpus_per_job = userConfig?.busco?.cpus_per_job ?: 4
}

// ============================================================================
// EXECUTOR - Pattern A (Sequential/Local)
// ============================================================================

executor {
    name = 'local'
    cpus = 16
    memory = '64 GB'
}

// ============================================================================
// PROCESS DEFAULTS
// ============================================================================

process {
    executor = 'local'

    // Error handling - fail fast for research pipelines
    errorStrategy = 'terminate'
    maxErrors = 0

    // Default resources
    cpus = 4
    memory = '16 GB'
    time = '6h'

    // Label-specific resources
    withLabel: 'local' {
        cpus = 4
        memory = '16 GB'
        time = '2h'
    }

    withLabel: 'busco' {
        cpus = 16
        memory = '64 GB'
        time = '24h'
    }
}

// ============================================================================
// MANIFEST
// ============================================================================

manifest {
    name = 'GIGANTIC-genomesDB-STEP_2'
    author = 'Eric Edsinger (with Claude Code AI)'
    description = 'Standardize genomic data with phylonames and evaluate quality'
    version = '1.0.0'
    nextflowVersion = '>=21.04.0'
}
